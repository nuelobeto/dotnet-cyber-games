@page "/packet-hopper"
@using System.Timers
@rendermode InteractiveServer
@implements IDisposable

<PageTitle>Packet Hopper - Day 14</PageTitle>

<div class="game-wrapper">
    <div class="stats-bar">
        <span>Status: <strong class="@(_isGameOver ? "text-danger" : "")">@(_isGameOver ? "DROPPED" : _isRunning ? "ROUTING" : "IDLE")</strong></span>
        <span>Speed: @($"{_obstacleSpeed:F1}x")</span>
        <span>Score: @(_score / 10)</span>
    </div>

    <div class="game-container">
        <div class="player" style="bottom: @(_playerY)px;">
            <div class="packet-core"></div>
        </div>

        @* Note: We cast speed/position to int for style rendering *@
        <div class="obstacle" style="left: @((int)_obstacleX)px;"></div>

        @if (!_isRunning && !_isGameOver && _score == 0)
        {
            <div class="overlay">
                <h2>PACKET HOPPER</h2>
                <p>Bypass the Firewalls</p>
                <button class="btn-main" @onclick="ToggleGame">INITIALIZE STREAM</button>
            </div>
        }

        @if (_isGameOver)
        {
            <div class="overlay">
                <h2 class="text-danger">PACKET DROPPED</h2>
                <p>Final Bandwidth: @(_score / 10) KB</p>
                <button class="btn-main" @onclick="ResetGame">RE-TRANSMIT</button>
            </div>
        }
    </div>

    <div class="controls">
        @if (_isRunning)
        {
            <button class="btn-jump" @onmousedown="Jump">JUMP</button>
        }
        
        <div class="button-group">
            <button class="btn" @onclick="ToggleGame">
                @(_isRunning ? "Pause" : "Start")
            </button>
            <button class="btn" @onclick="ResetGame">Reset</button>
        </div>
    </div>
</div>

@code {
    private bool _isRunning = false;
    private bool _isGameOver = false;
    private int _score = 0;

    // Physics
    private const int Gravity = 2;
    private const int JumpStrength = 20;
    private const int GroundY = 0;
    
    // Player State
    private int _playerY = 0;
    private int _playerVelocity = 0;
    private int _playerHeight = 40;
    private int _playerWidth = 40;

    // Obstacle State (Switched to double for gradual scaling)
    private double _obstacleX = 650;
    private double _obstacleSpeed = 8.0; 
    private double _speedIncrement = 0.002; // Adds speed every frame
    private int _obstacleWidth = 30;
    private int _obstacleHeight = 50;

    private void Jump()
    {
        if (!_isRunning || _isGameOver) return;
        if (_playerY <= GroundY) 
        {
            _playerVelocity = JumpStrength;
        }
    }

    private void ToggleGame()
    {
        if (_isGameOver) return;
        _isRunning = !_isRunning;
        if (_isRunning) GameLoop();
    }

    private async void GameLoop()
    {
        while (_isRunning && !_isGameOver)
        {
            UpdatePhysics();
            CheckCollision();
            
            _score++;
            // Gradually increase speed every frame
            _obstacleSpeed += _speedIncrement;

            StateHasChanged();
            await Task.Delay(20);
        }
    }

    private void UpdatePhysics()
    {
        // Jump/Gravity
        _playerY += _playerVelocity;
        if (_playerY > GroundY)
            _playerVelocity -= Gravity;
        else
        {
            _playerY = GroundY;
            _playerVelocity = 0;
        }

        // Obstacle movement
        _obstacleX -= _obstacleSpeed;
        if (_obstacleX < -50)
        {
            _obstacleX = 650;
        }
    }

    private void CheckCollision()
    {
        // Hitbox detection
        bool intersectsX = 50 + _playerWidth > _obstacleX && 50 < _obstacleX + _obstacleWidth;
        bool intersectsY = _playerY < _obstacleHeight;

        if (intersectsX && intersectsY)
        {
            _isRunning = false;
            _isGameOver = true;
        }
    }

    private void ResetGame()
    {
        _isRunning = false;
        _isGameOver = false;
        _score = 0;
        _playerY = 0;
        _playerVelocity = 0;
        _obstacleX = 650;
        _obstacleSpeed = 8.0; // Reset to base speed
        StateHasChanged();
    }

    public void Dispose() => _isRunning = false;
}

<style>
    :root {
        --neon-green: #00ff41;
        --cyber-red: #ff003c;
        --cyber-blue: #00f3ff;
        --bg-dark: #0d0208;
    }

    .game-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        font-family: 'Consolas', monospace;
        background: #111;
        padding: 20px;
        border-radius: 12px;
        color: var(--neon-green);
        width: 600px;
        margin: auto;
    }

    .stats-bar {
        width: 100%;
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        font-size: 0.9rem;
    }

    .game-container {
        width: 100%;
        height: 250px;
        background-color: var(--bg-dark);
        border: 2px solid var(--neon-green);
        position: relative;
        overflow: hidden;
        /* Subtle scanline effect */
        background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
        background-size: 100% 2px, 3px 100%;
    }

    .player {
        position: absolute;
        left: 50px;
        width: 40px;
        height: 40px;
        background: var(--cyber-blue);
        box-shadow: 0 0 15px var(--cyber-blue);
        border: 2px solid #fff;
    }

    .obstacle {
        position: absolute;
        bottom: 0;
        width: 30px;
        height: 50px;
        background: var(--cyber-red);
        box-shadow: 0 0 15px var(--cyber-red);
        border-top: 3px solid white;
    }

    .overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.85);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 10;
        text-align: center;
    }

    .controls {
        margin-top: 15px;
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 15px;
        align-items: center;
    }

    .btn-jump {
        width: 100%;
        height: 80px;
        background: rgba(0, 255, 65, 0.1);
        color: var(--neon-green);
        border: 2px solid var(--neon-green);
        font-weight: bold;
        font-size: 1.5rem;
        cursor: pointer;
        border-radius: 8px;
        transition: all 0.1s;
    }

    .btn-jump:active {
        background: var(--neon-green);
        color: black;
        transform: translateY(2px);
    }

    .button-group {
        display: flex;
        gap: 10px;
    }

    .btn {
        background: #333;
        border: 1px solid var(--neon-green);
        color: var(--neon-green);
        padding: 8px 16px;
        cursor: pointer;
    }

    .btn-main {
        background: var(--neon-green);
        color: black;
        border: none;
        padding: 12px 24px;
        font-weight: bold;
        cursor: pointer;
        margin-top: 10px;
    }

    .text-danger { color: var(--cyber-red); }
</style>