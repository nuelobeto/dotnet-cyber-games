@page "/battleships"
@rendermode InteractiveServer

<PageTitle>Network Breach (Battleships)</PageTitle>

<div class="game-container">
    <div class="header">
        <h1>NETWORK BREACH</h1>
        <p class="subtitle">Scan the grid to neutralize malicious nodes. Signature-based detection active.</p>
    </div>

    <div class="stats-bar">
        <div class="stat">Uplinks Remaining: <strong>@_turnsLeft</strong></div>
        <div class="stat">Threats Found: <strong>@_hits / 17</strong></div>
    </div>

    @if (_isGameOver)
    {
        <div class="overlay">
            <h2>@(isWinner ? "SYSTEM SECURED" : "CRITICAL FAILURE")</h2>
            <p>@_statusMessage</p>
            <button class="btn-reset" @onclick="InitializeGame">Re-initialize Network</button>
        </div>
    }

    <div class="grid">
        @for (int r = 0; r < GridSize; r++)
        {
            @for (int c = 0; c < GridSize; c++)
            {
                int row = r;
                int col = c;
                <div class="cell @GetCellClass(row, col)" @onclick="() => FirePing(row, col)">
                    @if (_grid[row, col].IsHit)
                    {
                        <span>@(_grid[row, col].HasShip ? "!!" : "x")</span>
                    }
                </div>
            }
        }
    </div>

    <div class="log">
        <p>> @_statusMessage</p>
    </div>
</div>

@code {
    private const int GridSize = 10;
    private Node[,] _grid = new Node[GridSize, GridSize];
    private int _turnsLeft = 40;
    private int _hits = 0;
    private bool _isGameOver = false;
    private bool isWinner = false;
    private string _statusMessage = "Awaiting Ping...";

    protected override void OnInitialized() => InitializeGame();

    private void InitializeGame()
    {
        _grid = new Node[GridSize, GridSize];
        for (int i = 0; i < GridSize; i++)
            for (int j = 0; j < GridSize; j++)
                _grid[i, j] = new Node();

        _turnsLeft = 40;
        _hits = 0;
        _isGameOver = false;
        _statusMessage = "Network grid online. Locate the encrypted malware.";
        
        PlaceShips();
    }

    private void PlaceShips()
    {
        int[] shipSizes = { 5, 4, 3, 3, 2 }; // Standard Battleship sizes
        Random rand = new();

        foreach (var size in shipSizes)
        {
            bool placed = false;
            while (!placed)
            {
                bool horizontal = rand.Next(2) == 0;
                int r = rand.Next(GridSize);
                int c = rand.Next(GridSize);

                if (CanPlace(r, c, size, horizontal))
                {
                    for (int i = 0; i < size; i++)
                    {
                        if (horizontal) _grid[r, c + i].HasShip = true;
                        else _grid[r + i, c].HasShip = true;
                    }
                    placed = true;
                }
            }
        }
    }

    private bool CanPlace(int r, int c, int size, bool horizontal)
    {
        if (horizontal && c + size > GridSize) return false;
        if (!horizontal && r + size > GridSize) return false;

        for (int i = 0; i < size; i++)
        {
            int checkR = horizontal ? r : r + i;
            int checkC = horizontal ? c + i : c;
            if (_grid[checkR, checkC].HasShip) return false;
        }
        return true;
    }

    private void FirePing(int r, int col)
    {
        if (_isGameOver || _grid[r, col].IsHit) return;

        _grid[r, col].IsHit = true;
        _turnsLeft--;

        if (_grid[r, col].HasShip)
        {
            _hits++;
            _statusMessage = "THREAT DETECTED: Malicious node integrity compromised!";
        }
        else
        {
            _statusMessage = "CLEAN: No signature found at coordinates.";
        }

        CheckGameState();
    }

    private void CheckGameState()
    {
        if (_hits == 17)
        {
            _isGameOver = true;
            isWinner = true;
            _statusMessage = "Network sanitized. All threats neutralized.";
        }
        else if (_turnsLeft <= 0)
        {
            _isGameOver = true;
            isWinner = false;
            _statusMessage = "System lockdown initiated. Malware has escaped.";
        }
    }

    private string GetCellClass(int r, int c)
    {
        var node = _grid[r, c];
        if (!node.IsHit) return "cell-unknown";
        return node.HasShip ? "cell-hit" : "cell-miss";
    }

    public class Node
    {
        public bool HasShip { get; set; } = false;
        public bool IsHit { get; set; } = false;
    }
}

<style>
    :root {
        --neon-green: #00ff41;
        --dark-bg: #0a0a0a;
        --cell-size: 40px;
    }

    .game-container {
      width: 100%;
      max-width: 600px;
        font-family: 'Courier New', Courier, monospace;
        background-color: var(--dark-bg);
        color: var(--neon-green);
        padding: 2rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: auto;
    }

    .header { text-align: center; margin-bottom: 20px; }
    
    .stats-bar {
        display: flex;
        gap: 30px;
        margin-bottom: 20px;
        font-size: 1.2rem;
        border-bottom: 1px solid var(--neon-green);
        padding-bottom: 10px;
    }

    .grid {
        display: grid;
        grid-template-columns: repeat(10, var(--cell-size));
        gap: 4px;
        background: #1a1a1a;
        padding: 5px;
        border: 2px solid var(--neon-green);
        box-shadow: 0 0 15px rgba(0, 255, 65, 0.2);
    }

    .cell {
        width: var(--cell-size);
        height: var(--cell-size);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: 0.2s;
        border: 1px solid #333;
    }

    .cell-unknown { background: #111; }
    .cell-unknown:hover { background: #222; border-color: var(--neon-green); }
    
    .cell-hit { 
        background: #ff003c; 
        color: white; 
        box-shadow: inset 0 0 10px rgba(255, 0, 0, 0.5);
    }

    .cell-miss { background: #333; color: #666; }

    .log {
        margin-top: 20px;
        width: 100%;
        max-width: 440px;
        height: 60px;
        background: #000;
        padding: 10px;
        border-left: 4px solid var(--neon-green);
    }

    .overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.95);
        padding: 2rem;
        border: 2px solid var(--neon-green);
        text-align: center;
        z-index: 10;
    }

    .btn-reset {
        background: var(--neon-green);
        color: black;
        border: none;
        padding: 10px 20px;
        font-weight: bold;
        cursor: pointer;
        margin-top: 10px;
    }
</style>