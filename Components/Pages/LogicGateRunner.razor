@page "/whack-a-vulnerability"
@using System.Timers
@rendermode InteractiveServer
@implements IDisposable

<PageTitle>Whack-a-Vulnerability</PageTitle>

<div class="game-outer">
    <div class="stats-bar">
        <span>SCORE: @score</span>
        <span>INTEGRITY: @integrity%</span>
        <span>LEVEL: @level</span>
    </div>

    <div class="game-container">
        @if (!gameRunning && !isGameOver)
        {
            <div class="overlay">
                <h1 class="cyan-glow">CYBER GAMES: DAY 13</h1>
                <p>Vulnerabilities are surfacing. Patch them before the breach.</p>
                <button class="btn-action" @onclick="StartGame">INITIALIZE DEFENSES</button>
            </div>
        }

        @if (isGameOver)
        {
            <div class="overlay">
                <h1 class="breach-text">SYSTEM BREACHED</h1>
                <p>Final Score: @score</p>
                <button class="btn-action" @onclick="ResetGame">RETRY SECURITY AUDIT</button>
            </div>
        }

        <div class="grid">
            @for (int i = 0; i < 9; i++)
            {
                int index = i;
                <div class="node">
                    @if (activeVulnerabilities.ContainsKey(index))
                    {
                        <div class="vulnerability @activeVulnerabilities[index].Type.ToLower()" 
                             @onclick="() => Patch(index)">
                            <div class="v-label">@activeVulnerabilities[index].Type</div>
                            <div class="v-timer" style="width: @(activeVulnerabilities[index].TimeLeft)%"></div>
                        </div>
                    }
                    <div class="node-bg"></div>
                </div>
            }
        </div>
    </div>

    <div class="controls">
        <button @onclick="TogglePause">@(isPaused ? "RESUME" : "PAUSE")</button>
        <button @onclick="ResetGame">RESET SYSTEM</button>
    </div>
</div>

@code {
    private bool gameRunning = false;
    private bool isPaused = false;
    private bool isGameOver = false;
    private int score = 0;
    private int integrity = 100;
    private int level = 1;
    private Timer? gameTimer;
    private Random rng = new();
    
    private Dictionary<int, Vulnerability> activeVulnerabilities = new();
    private string[] types = { "SQLi", "XSS", "BufferOverflow", "ZeroDay" };

    private class Vulnerability {
        public string Type { get; set; } = "";
        public double TimeLeft { get; set; } = 100;
        public int Health { get; set; } = 1;
    }

    private void StartGame() {
        gameRunning = true;
        isGameOver = false;
        score = 0;
        integrity = 100;
        level = 1;
        activeVulnerabilities.Clear();
        
        gameTimer = new Timer(20);
        gameTimer.Elapsed += GameLoop;
        gameTimer.Start();
    }

    private void GameLoop(object? sender, ElapsedEventArgs e) {
        if (isPaused || !gameRunning) return;

        InvokeAsync(() => {
            // Chance to spawn
            if (rng.Next(0, 100) < (3 + level) && activeVulnerabilities.Count < 4) {
                int slot = rng.Next(0, 9);
                if (!activeVulnerabilities.ContainsKey(slot)) {
                    string type = types[rng.Next(types.Length)];
                    activeVulnerabilities[slot] = new Vulnerability { 
                        Type = type, 
                        Health = type == "ZeroDay" ? 2 : 1 
                    };
                }
            }

            // Update timers
            var keys = activeVulnerabilities.Keys.ToList();
            foreach (var key in keys) {
                activeVulnerabilities[key].TimeLeft -= (1.0 + (level * 0.2));
                
                if (activeVulnerabilities[key].TimeLeft <= 0) {
                    integrity -= 10;
                    activeVulnerabilities.Remove(key);
                    if (integrity <= 0) GameOver();
                }
            }

            if (score > level * 100) level++;
            StateHasChanged();
        });
    }

    private void Patch(int index) {
        if (!activeVulnerabilities.ContainsKey(index)) return;
        
        activeVulnerabilities[index].Health--;
        if (activeVulnerabilities[index].Health <= 0) {
            score += 10;
            activeVulnerabilities.Remove(index);
        }
    }

    private void GameOver() {
        gameRunning = false;
        isGameOver = true;
        gameTimer?.Stop();
    }

    private void TogglePause() => isPaused = !isPaused;
    private void ResetGame() { gameTimer?.Stop(); StartGame(); }
    public void Dispose() => gameTimer?.Dispose();
}

<style>
    .game-outer {
        max-width: 600px;
        margin: 0 auto;
        background: #0a0a0a;
        color: #00f2ff;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        padding: 15px;
        border: 2px solid #00f2ff;
        box-shadow: 0 0 20px rgba(0, 242, 255, 0.2);
    }

    .stats-bar {
        display: flex;
        justify-content: space-between;
        font-weight: bold;
        margin-bottom: 15px;
        letter-spacing: 1px;
    }

    .game-container {
        width: 100%;
        height: 500px;
        position: relative;
        background: #000;
        border: 1px solid #333;
    }

    .grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-template-rows: repeat(3, 1fr);
        height: 100%;
        gap: 10px;
        padding: 10px;
    }

    .node {
        position: relative;
        background: #111;
        border: 1px solid #222;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .vulnerability {
        position: absolute;
        width: 80%;
        height: 80%;
        z-index: 5;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border-radius: 4px;
        animation: pop 0.2s ease-out;
    }

    .sqli { background: #ff9900; color: #000; }
    .xss { background: #ff00ff; color: #000; }
    .bufferoverflow { background: #00ff00; color: #000; }
    .zeroday { background: #ff0000; color: #fff; border: 2px solid white; }

    .v-label { font-size: 0.7rem; font-weight: bold; text-align: center; padding: 2px; }
    .v-timer { height: 4px; background: rgba(255,255,255,0.5); position: absolute; bottom: 0; left: 0; }

    .node-bg { width: 40%; height: 40%; border: 1px solid #333; transform: rotate(45deg); }

    .overlay {
        position: absolute;
        top:0; left:0; width:100%; height:100%;
        background: rgba(0,0,0,0.9);
        z-index: 10;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
    }

    .btn-action {
        background: transparent;
        color: #00f2ff;
        border: 1px solid #00f2ff;
        padding: 10px 20px;
        margin-top: 20px;
        cursor: pointer;
        transition: 0.3s;
    }

    .btn-action:hover { background: #00f2ff; color: #000; }

    .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }

    .cyan-glow { text-shadow: 0 0 10px #00f2ff; }
    .breach-text { color: #ff0000; text-shadow: 0 0 10px #ff0000; }

    @@keyframes pop {
        0% { transform: scale(0.5); }
        100% { transform: scale(1); }
    }
</style>